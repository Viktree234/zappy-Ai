<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Zappy AI Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-danger mb-4">
  <div class="container-fluid">
    <span class="navbar-brand">ðŸ¤–Â ZappyÂ AIÂ Dashboard</span>
    <a class="btn btn-light btn-sm" href="/logout">Logout</a>
  </div>
</nav>

<div class="container">
  <div class="row g-4">

    <!-- Status + Pair -->
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-header fw-bold">Status</div>
        <div class="card-body">
          <p id="status">Loadingâ€¦</p>
          <div id="pairBox"></div>
          <button id="startBtn" class="btn btn-success mt-2">Start Bot</button>
        </div>
      </div>
    </div>

    <!-- Broadcast -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header fw-bold">Broadcast</div>
        <div class="card-body">
          <form id="bcForm">
            <textarea class="form-control mb-2" rows="4" placeholder="Message"></textarea>
            <button class="btn btn-danger w-100">Send</button>
          </form>
          <p id="bcInfo" class="text-success small mt-1"></p>
        </div>
      </div>
    </div>

    <!-- Quick Test -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header fw-bold">QuickÂ Test</div>
        <div class="card-body">
          <form id="testForm">
            <input class="form-control mb-2" placeholder="WhatsAppÂ JID e.g. 12345@s.whatsapp.net">
            <textarea class="form-control mb-2" rows="3" placeholder="Message"></textarea>
            <button class="btn btn-primary w-100">Send</button>
          </form>
          <p id="sendInfo" class="text-success small mt-1"></p>
        </div>
      </div>
    </div>

    <!-- Activity -->
    <div class="col-12">
      <div class="card">
        <div class="card-header fw-bold">LatestÂ Activity</div>
        <pre id="feed" class="m-0 p-3 bg-dark text-light" style="height:240px;overflow:auto">Loadingâ€¦</pre>
      </div>
    </div>

  </div>
</div>

<script>
async function load(){
  const st=await fetch('/status').then(r=>r.json())
  document.getElementById('status').textContent = st.running?'ðŸŸ¢ Bot running':'ðŸ”´ Bot stopped'
  document.getElementById('startBtn').disabled = st.running
  const box=document.getElementById('pairBox')
  if(st.qr) box.innerHTML='<img class="img-thumbnail" src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data='+encodeURIComponent(st.qr)+'">'
  else if(st.pairingCode) box.innerHTML='<p class="fw-bold">ðŸ“² Pair Code:<br>'+st.pairingCode+'</p>'
  else box.innerHTML=''
  // feed
  const logs = await fetch('/logs').then(r=>r.json())
  const last = logs.slice(-10).map(l=>`[${l.time.slice(11,19)}] ${l.who}: ${l.msg}`).join('\n')
  document.getElementById('feed').textContent = last || '(no activity)'
}
load(); setInterval(load,3000)

// buttons & forms
document.getElementById('startBtn').onclick = ()=>fetch('/start').then(()=>setTimeout(load,1500))
document.getElementById('bcForm').onsubmit = async e=>{
  e.preventDefault()
  const txt=e.target[0].value.trim(); if(!txt) return
  const r=await fetch('/broadcast',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:txt})}).then(r=>r.json())
  document.getElementById('bcInfo').textContent = r.ok?`Sent to ${r.sent} users`:'Error'
  e.target.reset()
}
document.getElementById('testForm').onsubmit = async e=>{
  e.preventDefault()
  const to=e.target[0].value.trim(), txt=e.target[1].value.trim(); if(!to||!txt) return
  const r=await fetch('/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,text:txt})})
  document.getElementById('sendInfo').textContent = r.ok?'Sent!':'Error'
  e.target.reset()
}
</script>
</body>
</html>
